# Диагностика проблемы с кнопкой "Я подписался — проверить"

## Проблема
Кнопка "Я подписался — проверить" не работает - при нажатии ничего не происходит.

## Исправления в коде

1. **Улучшен обработчик кнопки `chk_sub`**:
   - Добавлено подробное логирование
   - Улучшен поиск состояния сессии (3 способа)
   - Добавлена диагностика состояния

2. **Улучшено сохранение состояния**:
   - Состояние теперь сохраняется и в wizard.state и в session.__state
   - Это обеспечивает доступность данных в обработчике кнопки

3. **Добавлен отладочный обработчик**:
   - Логирует все callback_query для диагностики

## Как тестировать

Поскольку бот уже работает на продакшене, локальное тестирование невозможно из-за конфликта.

### Проверьте логи на продакшен сервере:

1. **При нажатии кнопки должны появиться логи**:
   ```
   [callback_query] Получен callback от пользователя XXXXX: chk_sub
   [chk_sub] Проверка подписки для пользователя XXXXX
   [chk_sub] Текущая сцена: buy-wizard (или sell-wizard)
   [chk_sub] Состояние сессии: {...}
   ```

2. **При отсутствии подписки**:
   ```
   [chk_sub] Пользователь XXXXX всё ещё не подписан на: @nomera_russian
   ```
   И пользователь должен увидеть alert с сообщением.

3. **При наличии подписки**:
   ```
   [chk_sub] Пользователь XXXXX подписан на все каналы!
   [chk_sub] Найдено состояние: post=true, intent=buy
   [chk_sub] Публикую сохранённое сообщение...
   ```

### Если логи не появляются:
- Проблема в том, что callback_query вообще не доходит до бота
- Возможно, проблема с кнопкой или webhook'ом

### Если логи есть, но состояние не найдено:
- Проблема в сохранении/получении состояния сессии
- Нужно проверить middleware сессий

## Команды для диагностики

```bash
# Проверить состояние каналов
npm run chat:info

# Проверить подписки конкретного пользователя  
npm run debug:subs
```
